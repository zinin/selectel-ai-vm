# Review Iteration 1 — 2026-01-31 14:55

## Источник

- Design: `docs/plans/2026-01-31-selectel-api-automation-design.md`
- Plan: `docs/plans/2026-01-31-selectel-api-automation-impl.md`
- Codex output: `/home/zinin/.claude/codex-interaction/2026-01-31-14-49-06-design-review-selectel-api-automation-iter-1/output.txt`

## Замечания

### [ARCH-1] Нет создания/валидации сети и security group

> В конфигурации есть `NETWORK_NAME`, `SUBNET_CIDR`, `SECURITY_GROUP`, однако playbooks не создают и не проверяют сеть/подсеть/SG. Если сеть/SG отсутствуют или не содержат правила для SSH, VM либо не создастся, либо будет недоступна.

**Статус:** Новое
**Ответ:** Добавить playbooks для сети/SG (Recommended)
**Действие:** Добавить в план задачи для создания/проверки сети, подсети и SG с правилами SSH

---

### [IMPL-1] Прерываемые серверы не гарантированы текущей реализацией

> Для spot/preemptible используется `meta: preemptible`, но Selectel может требовать другой механизм (flavor, scheduler hints, отдельный API флаг).

**Статус:** Новое
**Ответ:** Проверить требования Selectel (Recommended)
**Действие:** Изучить документацию Selectel и реализовать корректный механизм для прерываемых серверов

---

### [IMPL-2] Фиксированные имена VM/дисков ломают параллельность

> `gpu-start` и `setup-start` используют один и тот же `vm_name` и имя диска `{{ vm_name }}-boot`. Повторный запуск может переиспользовать старый диск.

**Статус:** Новое
**Ответ:** Добавить --name, генерировать уникальные (Recommended)
**Действие:** Добавить параметры --name и --disk-name, по умолчанию генерировать timestamp/uuid

---

### [ERR-1] Недостаточная валидация входных данных

> В `gpu-start` не проверяется `GPU_FLAVOR_ID`, а поиск диска/образа по имени не проверяет «0» и «>1» совпадений.

**Статус:** Новое
**Ответ:** Явная валидация (Recommended)
**Действие:** Валидировать обязательные переменные и единственность найденных ресурсов

---

### [EDGE-1] Размер boot-диска может оказаться меньше образа

> `default_disk_size` берётся из `.env` и может быть меньше `image.min_disk`.

**Статус:** Новое
**Ответ:** Вычислять max() автоматически (Recommended)
**Действие:** Размер = max(default_disk_size, image.min_disk) с возможностью override

---

### [IMPL-3] Зависимость от openstack CLI без проверки версии

> `image-create-from-disk` и `image-download` используют CLI, но не проверяют наличие/версию.

**Статус:** Новое
**Ответ:** Перейти на модули openstack.cloud (Recommended)
**Действие:** Использовать Ansible-модули вместо CLI для операций с образами

---

### [ERR-2] Ожидание создания образа по имени может «схватить» старый образ

> После `openstack image create` ожидание идёт по имени. Если образ с таким именем уже существует, playbook может завершиться «успешно».

**Статус:** Новое
**Ответ:** Ждать по ID (Recommended)
**Действие:** Получать ID созданного образа и ждать по ID; при коллизии имени — падать

---

### [IMPL-4] Сохранение boot-диска при удалении VM не гарантировано (КРИТИЧНО)

> `gpu-stop` обещает сохранить диск, но в `openstack.cloud.server` не задано `terminate_volume: false`. Риск потери данных!

**Статус:** Новое
**Ответ:** Установить terminate_volume: false (Recommended)
**Действие:** Явно выставить флаг при создании серверов и/или проверять delete_on_termination

---

### [SEC-1] Статичное имя keypair может перезаписать существующий ключ

> `ansible-key` фиксирован. В общем проекте можно случайно заменить ключ другого пользователя.

**Статус:** Новое
**Ответ:** Конфигурируемое имя (Recommended)
**Действие:** Добавить SSH_KEY_NAME в .env, сверять fingerprint перед перезаписью

---

### [EDGE-2] Неявное управление Floating IP может не работать

> `auto_ip: true` без указания внешней сети/пула часто не работает в облаках с несколькими внешними сетями.

**Статус:** Новое
**Ответ:** Явно указывать EXTERNAL_NETWORK (Recommended)
**Действие:** Выделять FIP через openstack.cloud.floating_ip с параметром EXTERNAL_NETWORK

---

### [DOC-1] Инструкция по доступу (root) не соответствует Ubuntu-образам

> В документации предлагается `ssh root@...`, а Ubuntu cloud images обычно используют пользователя `ubuntu`.

**Статус:** Новое
**Ответ:** Не применимо — Selectel-образы Ubuntu идут с root-доступом изначально, roles/user добавляет пользователя
**Действие:** Нет изменений, документация корректна для Selectel

---

## Изменения в документах

| Файл | Изменение |
|------|-----------|
| (пока не применены) | Требуется обновление плана с учётом 10 замечаний |

## Статистика

- Всего замечаний: 11
- Новых: 11
- Повторов (автоответ): 0
- Не применимых: 1 (DOC-1)
- Требует действий: 10
- Пользователь сказал "стоп": Нет

## Следующие шаги

Обновить план имплементации (`docs/plans/2026-01-31-selectel-api-automation-impl.md`) с учётом принятых решений:

1. **ARCH-1**: Добавить playbooks для сети/подсети/SG
2. **IMPL-1**: Исследовать API Selectel для preemptible
3. **IMPL-2**: Параметры --name, генерация уникальных имён
4. **ERR-1**: Валидация обязательных переменных и ресурсов
5. **EDGE-1**: Автоматический расчёт размера диска
6. **IMPL-3**: Переход на Ansible-модули вместо CLI
7. **ERR-2**: Ожидание образа по ID
8. **IMPL-4**: terminate_volume: false
9. **SEC-1**: Конфигурируемое имя keypair
10. **EDGE-2**: Явное указание EXTERNAL_NETWORK
