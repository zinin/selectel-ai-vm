# Review Iteration 2 — 2026-01-31 15:55

## Источник

- Design: `docs/plans/2026-01-31-selectel-api-automation-design.md`
- Plan: `docs/plans/2026-01-31-selectel-api-automation-impl.md`
- Codex output: `/home/zinin/.claude/codex-interaction/2026-01-31-15-44-56-design-review-selectel-api-automation-iter-2/output.txt`

## Замечания

### [ERR-2] Удаление/скачивание по неуникальным именам

> В `disk-delete`, `image-delete` и `image-download` нет проверки уникальности ресурса. В OpenStack имена не уникальны, можно удалить не тот объект.

**Статус:** Новое
**Ответ:** Добавить валидацию (Recommended) — проверять что найден ровно 1 ресурс, иначе — ошибка с выводом всех найденных
**Действие:** Добавлена валидация уникальности во все три playbook

---

### [SEC-1] `SECURITY_GROUP=default` блокирует SSH

> `.env.example` задает `default`, но `network-setup` не добавляет правила для default-группы. VM будут недоступны по SSH/ICMP.

**Статус:** Новое
**Ответ:** Добавлять правила в default (Recommended) — network-setup добавляет SSH/ICMP правила в указанную SG
**Действие:** Убрано условие `when: security_group != 'default'` для правил SSH/ICMP, добавлен `ignore_errors: true`

---

### [IMPL-1] `gpu-stop` без `--name` не работает

> Документация показывает `./selectel.sh gpu-stop` без имени, но playbook требует `vm_name` как обязательный параметр.

**Статус:** Новое
**Ответ:** Убрать обязательность (Recommended) — если --name не указан, показать список VM и попросить выбрать
**Действие:** Добавлена логика: при отсутствии vm_name выводится список VM с датой создания

---

### [IMPL-2] Неверный параметр в `image_info`

> В `image-download.yml` и `image-delete.yml` используется `name:`, тогда как в других местах - `image:`.

**Статус:** Новое
**Ответ:** Исправить на image: (Recommended) — использовать единообразный параметр
**Действие:** Исправлено `name:` → `image:` в обоих playbook

---

### [ERR-1] Ошибка при `ALLOCATE_FLOATING_IP=false`

> При отключенном floating IP переменная не определена, playbook падает на выводе результатов.

**Статус:** Новое
**Ответ:** Добавить default (Recommended) — использовать `| default('not allocated')` в шаблоне вывода
**Действие:** Изменён шаблон вывода на безопасную проверку `if floating_ip is defined`

---

### [ERR-3] Нет отката при частичном создании

> Если том создан, но сервер не создался - том остается навсегда и стоит денег.

**Статус:** Новое
**Ответ:** Добавить откат (Recommended) — при ошибке создания сервера удалять созданный том
**Действие:** Добавлен block/rescue в gpu-start для отката тома при ошибке

---

### [EDGE-1] `--disk` и `--image` одновременно

> `selectel.sh gpu-start` принимает оба параметра и молча отдает приоритет `--disk`.

**Статус:** Новое
**Ответ:** Выдавать ошибку (Recommended) — запретить одновременное указание обоих параметров
**Действие:** Добавлена проверка в selectel.sh: `if [[ -n "$DISK_NAME" && -n "$IMAGE_NAME" ]]; then exit 1`

---

## Изменения в документах

| Файл | Изменение |
|------|-----------|
| `design.md` | Добавлено 6 новых требований в таблицу "Важные детали реализации" |
| `impl.md` (Task 1) | Добавлена валидация взаимоисключающих параметров --disk/--image |
| `impl.md` (Task 7) | Убрано условие when для правил SG, добавлен ignore_errors |
| `impl.md` (Task 8) | Добавлен block/rescue для отката тома, исправлен вывод floating IP |
| `impl.md` (Task 9) | Добавлена логика показа списка VM при отсутствии --name |
| `impl.md` (Task 11) | Добавлена валидация уникальности volume |
| `impl.md` (Task 13) | Добавлена валидация уникальности image, исправлен параметр на `image:` |
| `impl.md` (Task 15) | Добавлена валидация уникальности image, исправлен параметр на `image:` |
| `impl.md` (Summary) | Добавлена секция "Iteration 2" с 7 изменениями |

## Статистика

- Всего замечаний: 7
- Новых: 7
- Повторов (автоответ): 0
- Пользователь сказал "стоп": Нет
