# playbooks/infra/setup-start.yml
---
- name: Start setup VM (without GPU, for initial configuration)
  hosts: localhost
  connection: local
  gather_facts: true  # Нужно для ansible_date_time

  vars_files:
    - vars/main.yml

  vars:
    # vm_name может быть переопределён через -e
    flavor_id: "{{ setup_flavor_id }}"
    # base_image задаётся интерактивно если не указан
    base_image: ""

  tasks:
    # === Валидация ===
    - name: Validate flavor is set
      ansible.builtin.fail:
        msg: "SETUP_FLAVOR_ID must be set in .env"
      when: flavor_id == ""

    # === Интерактивный выбор образа если не указан ===
    - name: Get all public images (when base_image not specified)
      openstack.cloud.image_info:
      register: all_images
      when: base_image == ""

    - name: Display available images and fail (when base_image not specified)
      ansible.builtin.fail:
        msg: |
          base_image is required. Available Ubuntu images:
          {% for img in all_images.images | selectattr('name', 'search', 'Ubuntu') | sort(attribute='name') %}
          - {{ img.name }}
          {% endfor %}

          Set BASE_IMAGE_NAME in .env or pass via -e base_image="<name>"
      when: base_image == ""

    # === Генерация имени VM если не задано ===
    - name: Set default VM name with timestamp
      ansible.builtin.set_fact:
        vm_name: "{{ vm_name | default('setup-vm-' + ansible_date_time.date | replace('-','') + '-' + ansible_date_time.time | replace(':','')) }}"

    # === Проверка уникальности имени VM ===
    - name: Check if VM with same name already exists
      openstack.cloud.server_info:
        server: "{{ vm_name }}"
      register: existing_vm

    - name: Fail if VM already exists
      ansible.builtin.fail:
        msg: "VM '{{ vm_name }}' already exists. Use different --name or delete existing VM."
      when: existing_vm.servers | length > 0

    # === SSH keypair с проверкой fingerprint ===
    - name: Read SSH public key
      ansible.builtin.set_fact:
        ssh_public_key: "{{ lookup('file', ssh_key_file | expanduser) }}"

    - name: Calculate local key fingerprint (MD5 format for OpenStack compatibility)
      ansible.builtin.shell: |
        ssh-keygen -E md5 -lf {{ ssh_key_file | expanduser | quote }} | awk '{print $2}' | sed 's/^MD5://'
      register: local_fingerprint
      changed_when: false

    - name: Get existing keypair info
      openstack.cloud.keypair_info:
        name: "{{ ssh_key_name }}"
      register: existing_keypair

    - name: Fail if keypair exists with different fingerprint
      ansible.builtin.fail:
        msg: "Keypair '{{ ssh_key_name }}' exists with different fingerprint. Cloud: {{ existing_keypair.keypairs[0].fingerprint }}, Local: {{ local_fingerprint.stdout }}"
      when: >
        existing_keypair.keypairs | length > 0 and
        existing_keypair.keypairs[0].fingerprint != local_fingerprint.stdout

    - name: Ensure keypair exists
      openstack.cloud.keypair:
        state: present
        name: "{{ ssh_key_name }}"
        public_key: "{{ ssh_public_key }}"
      when: existing_keypair.keypairs | length == 0

    # === Image ===
    - name: Get base image info
      openstack.cloud.image_info:
        image: "{{ base_image }}"
      register: image_info

    - name: Validate exactly one image found
      ansible.builtin.fail:
        msg: "Expected exactly 1 image named '{{ base_image }}', found {{ image_info.images | length }}"
      when: image_info.images | length != 1

    # === Disk ===
    - name: Calculate disk size (max of default and image min_disk)
      ansible.builtin.set_fact:
        actual_disk_size: "{{ [default_disk_size | int, image_info.images[0].min_disk | default(0) | int] | max }}"

    # Проверяем, что boot volume не существует
    - name: Check if boot volume already exists
      openstack.cloud.volume_info:
        name: "{{ vm_name }}-boot"
      register: existing_boot_volume

    - name: Fail if boot volume already exists
      ansible.builtin.fail:
        msg: "Boot volume '{{ vm_name }}-boot' already exists. Use different --name or delete existing volume."
      when: existing_boot_volume.volumes | length > 0

    # Используем block/rescue для отката тома при ошибке
    - name: Create volume and server
      block:
        - name: Create boot volume
          openstack.cloud.volume:
            state: present
            name: "{{ vm_name }}-boot"
            size: "{{ actual_disk_size }}"
            volume_type: "{{ default_disk_type }}"
            image: "{{ image_info.images[0].id }}"
            availability_zone: "{{ availability_zone }}"
            wait: true
          register: boot_volume

        - name: Create setup server
          openstack.cloud.server:
            state: present
            name: "{{ vm_name }}"
            flavor: "{{ flavor_id }}"
            boot_volume: "{{ boot_volume.volume.id }}"
            terminate_volume: false
            key_name: "{{ ssh_key_name }}"
            security_groups:
              - "{{ security_group }}"
            networks:
              - name: "{{ network_name }}"
            availability_zone: "{{ availability_zone }}"
            auto_ip: false
            timeout: "{{ server_create_timeout }}"
            wait: true
          register: server

      rescue:
        - name: Capture original error
          ansible.builtin.set_fact:
            original_error: "{{ ansible_failed_result.msg | default('Unknown error') }}"

        - name: Cleanup volume on server creation failure
          openstack.cloud.volume:
            state: absent
            name: "{{ vm_name }}-boot"
          when: boot_volume.volume is defined
          ignore_errors: true

        - name: Fail with original error
          ansible.builtin.fail:
            msg: "Server creation failed: {{ original_error }}. Volume {{ vm_name }}-boot was cleaned up."

    # === Floating IP ===
    - name: Allocate floating IP
      openstack.cloud.floating_ip:
        state: present
        server: "{{ server.server.id }}"
        network: "{{ external_network }}"
        wait: true
      register: floating_ip
      when: allocate_floating_ip | bool

    # === Результат ===
    - name: Display server info
      ansible.builtin.debug:
        msg: |

          ========================================
          Setup VM Created Successfully!
          ========================================
          Name: {{ server.server.name }}
          ID: {{ server.server.id }}
          Status: {{ server.server.status }}
          Floating IP: {{ floating_ip.floating_ip.floating_ip_address if floating_ip is defined and floating_ip.floating_ip is defined else 'not allocated' }}

          Next steps:
          1. Add IP to inventory/hosts.yml
          2. Run: ansible-playbook playbooks/site.yml
          3. Create image: ./selectel.sh image-create-from-disk --disk "{{ vm_name }}-boot" --name "base-image"

          Connect: ssh root@{{ floating_ip.floating_ip.floating_ip_address if floating_ip is defined and floating_ip.floating_ip is defined else '<floating_ip>' }}
          ========================================
