---
- name: Check if Ollama is installed
  ansible.builtin.command: ollama --version
  register: ollama_check
  changed_when: false
  failed_when: false

- name: Download and install Ollama
  ansible.builtin.shell: |
    set -o pipefail
    curl -fsSL https://ollama.com/install.sh | sh
  args:
    executable: /bin/bash
  when: ollama_check.rc != 0
  changed_when: true

- name: Create Ollama systemd override directory
  ansible.builtin.file:
    path: /etc/systemd/system/ollama.service.d
    state: directory
    mode: '0755'

- name: Configure Ollama service environment
  ansible.builtin.copy:
    dest: /etc/systemd/system/ollama.service.d/override.conf
    content: |
      [Service]
      Environment="OLLAMA_KEEP_ALIVE=-1"
      Environment="OLLAMA_CONTEXT_LENGTH=30000"
    mode: '0644'
  notify: Restart Ollama

- name: Ensure Ollama service is enabled and running
  ansible.builtin.systemd:
    name: ollama
    enabled: true
    state: started
    daemon_reload: true

- name: Pull Ollama models
  ansible.builtin.command: ollama pull {{ item }}
  loop: "{{ ollama_models }}"
  register: ollama_pull_result
  changed_when: "'pulling' in ollama_pull_result.stdout"
